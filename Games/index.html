<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpaceWar</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <link rel="stylesheet" href="css/main.css">
    <style>
        @font-face {
            font-family: SportypoReguler;
            src: url("assets/font/SportypoReguler.ttf");
        }
    </style>
</head>
<body>
<script>
    vkBridge.send('VKWebAppInit');
    var config = {
        type: Phaser.AUTO,
        width: "100%",
        height: "100%",
        physics: {
            default: 'arcade',
            arcade: {
                //gravity: { y: 200 }
                debug: false
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };

    let game = new Phaser.Game(config);
    let sky = [];
    let asteroids = [];
    let user_id;

    function preload() {

        let {width, height} = this.sys.game.canvas;
        var loadingText = this.make.text({
            x: width / 2 - 50,
            y: height / 2 - 50,
            text: 'Loading...',
            style: {
                font: '20px monospace',
                fill: '#ffffff',
                fontFamily: "SportypoReguler"
            }
        });
        var progressBar = this.add.graphics();
        var progressBox = this.add.graphics();
        progressBox.fillStyle(0x222222, 0.8);
        progressBox.fillRect(width / 2 - 100, height / 2, 200, 15);
        this.load.on('progress', function (value) {
            console.log(value);
            progressBar.clear();
            progressBar.fillStyle(0xffffff, 1);
            progressBar.fillRect(width / 2 - 200 / 2, height / 2, 200 * value, 15);
        });

        this.load.on('fileprogress', function (file) {
            console.log(file.src);
        });
        this.load.on('complete', function () {
            progressBar.destroy();
            progressBox.destroy();
        });
        this.load.setBaseURL('/');

        this.cameras.main.backgroundColor.setTo(50, 52, 67);
        this.load.image('blue_player', 'assets/imgs/Graphics Asset - Spaceships/SVG/Spaceships/01/Spaceship_01_BLUE.svg');
        this.load.image('sky', 'assets/imgs/back/Blue Nebula/Blue Nebula 4 - 1024x1024.png');
        this.load.image('aster', 'assets/imgs/Items/Asteroids.png');
        this.load.image('aster2', 'assets/imgs/Items/aster.png');
        this.load.image('start', 'assets/imgs/start.png');
        this.load.image('logo', 'assets/imgs/logo.png');
        this.load.image('lead', 'assets/imgs/leaderboard.png');
        this.load.image('share', 'assets/imgs/share.png');
        this.load.image('restart', 'assets/imgs/restart.png');
        this.load.spritesheet("booman", "assets/imgs/expl.png", {frameWidth: 64, frameHeight: 64});
        this.load.audio('back', ['assets/sound/Automation.mp3']);
        this.load.audio('booomau', ['assets/sound/boom.mp3']);
        this.load.spritesheet("fire", "assets/imgs/Graphics Asset - Spaceships/PNG/imsheet.png", {
            frameWidth: 36,
            frameHeight: 82
        });
        vkBridge.send("VKWebAppGetUserInfo").then((r) => {
            user_id = r.id;
        });
    }

    let startGame = false;
    let player;
    let speedAsteroids = 80;
    let spawnDelay = 2000;
    let firGrp;
    let gameOver = false;
    let score = 0;
    let scoreText;
    let move = false;
    let fireFly;
    let gameThis;
    let scoreInterval;
    let music;

    function update() {

        let pointer = game.input.activePointer;
        let {width, height} = this.sys.game.canvas;
        /*fireFly.y = player.y+(player.displayHeight-30);
        fireFly.x = player.x-9;*/
        if (pointer.isDown && !gameOver && startGame) {
            let distance = Phaser.Math.Distance.BetweenPoints(player, pointer);
            if (distance > 3) {
                move = false;
                this.physics.moveToObject(player, pointer, 240);
                let angle = Phaser.Math.RAD_TO_DEG * Phaser.Math.Angle.Between(player.x, player.y, pointer.x, pointer.y);
                player.setAngle(angle + 90);
                //fireFly.setAngle(angle+90);
            } else {
                if (!move) {
                    move = true;
                    player.body.reset(player.x, player.y);
                }
            }
        }
        if (startGame) {
            if (sky[0].y - height > height) {
                let a = this.physics.add.sprite(width / 2, sky[sky.length - 1].y - 1020, 'sky');
                sky.push(a)
                a.body.velocity.y = 80;
                sky.shift();
            }
            if (asteroids[0].y - height > height) {
                asteroids.shift();
            }
        }

    }

    function spawnAsteroid(what) {
        if (gameOver)
            return false;
        let type = [
            "aster",
            "aster2",
        ]
        let {width, height} = what.sys.game.canvas;
        let a = what.physics.add.sprite(Phaser.Math.Between(20, width - 20), -200, type[Phaser.Math.Between(0, 1)]);
        a.angle = Phaser.Math.Between(0, 180)
        if (score > 50)
            a.body.velocity.y = Phaser.Math.Between(speedAsteroids, speedAsteroids + 25);
        else
            a.body.velocity.y = speedAsteroids;
        //a.body.setSize(a.width, a.height);
        what.physics.add.overlap(player, a, boom);
        asteroids.push(a)
        setTimeout(() => {
            spawnAsteroid(what)
        }, spawnDelay)
    }

    function boom(e) {
        let {width, height} = gameThis.sys.game.canvas;
        if (!gameOver) {
            player.body.reset(player.x, player.y);
            player.destroy();
            gameOver = true;
            player = gameThis.physics.add.sprite(player.x, player.y, "booman");
            player.body.velocity.y = speedAsteroids;
            player.setScale(2)
            music.stop();
            music = gameThis.sound.add('booomau');
            music.play();
            player.play("booman");
            vkBridge.send("VKWebAppTapticImpactOccurred", {"style": "heavy"});
            setTimeout(() => {
                let textGame = gameThis.add.text(width / 2 - 90, 150, 'Game Over',
                    {fontSize: '45px', fill: '#ffffff', fontFamily: "SportypoReguler"});
                let scc = gameThis.add.text(width / 2 - 50, 200, 'Score: ' + score,
                    {fontSize: '30px', fill: '#ffffff', fontFamily: "SportypoReguler"});
                let restart = gameThis.add.image(width / 2, 300, 'restart');
                textGame.setDepth(10)
                scc.setDepth(10)
                restart.setDepth(10)
                restart.setScale(.4)
                vkBridge.send("VKWebAppStorageGet", {"keys": ["score"]}).then((r)=>{
                    console.log("share its",score)
                    if(r.keys.length > 0) {
                        console.log("yes",parseInt(r.keys[0].value) , score)
                        if (parseInt(r.keys[0].value) < score || !parseInt(r.keys[0].value) || isNaN(parseInt(r.keys[0].value))) {
                            console.log("ye1s",parseInt(r.keys[0].value) , score)
                            vkBridge.send("VKWebAppStorageSet", {"key": "score", "value": score}).then((r)=>console.log("result",r)).catch((r)=>{
                                console.log("error to SV",r)
                            });
                        }
                    }else{vkBridge.send("VKWebAppStorageSet", {"key": "score", "value": score});}
                });
                vkBridge.send("VKWebAppCallAPIMethod",
                    {
                        "method": "secure.addAppEvent",
                        "params": {
                            "user_id": user_id,
                            "activity_id": 2,
                            "value": score,
                            "v":"5.131",
                            "access_token": "02af1c2f02af1c2f02af1c2fb902d652bd002af02af1c2f63902d2e2434800cc7e34e5b"
                        }
                    }).then((r) => {

                }).catch((r) => {

                });
                restart.setInteractive().on('pointerdown', () => {

                    restart.destroy();
                    vkBridge.send("VKWebAppShowNativeAds", {ad_format: "reward"}).then(()=>{
                        clearInterval(scoreInterval)
                        score = 0;
                        scoreText.setText(score);
                        speedAsteroids = 80;
                        spawnDelay = 2000;
                        gameOver = false;
                        startGame = false;
                        gameThis.scene.restart();
                    }).catch(()=>{
                        clearInterval(scoreInterval)
                        score = 0;
                        scoreText.setText(score);
                        speedAsteroids = 80;
                        spawnDelay = 2000;
                        gameOver = false;
                        startGame = false;
                        gameThis.scene.restart();
                    })
                });
            }, 600)
        }

    }

    function create() {
        gameThis = this;
        let {width, height} = this.sys.game.canvas;
        scoreText = this.add.text(20, 10, '0', {fontSize: '30px', fill: '#ffffff', fontFamily: "SportypoReguler"});
        /*  let di =
              this.add.text(width/2-20, height-150, 'Tap', {fontSize: '30px', fill: '#ffffff', fontFamily: "SportypoReguler"});*/
        music = this.sound.add('back');
        music.loop = true;
        music.play();

        let di = this.add.image(width / 2, height - 250, 'start');
        let share = this.add.image(width / 2, height - 110, 'share');
        let log = this.add.image(width / 2, height - 450, 'logo');
        let leadBut = this.add.image(width / 2, height - 180, 'lead');
        di.setDepth(5)
        share.setDepth(5)
        log.setDepth(5)
        leadBut.setDepth(5)
        leadBut.setScale(.4)
        share.setScale(.4)
        log.setScale(.7)
        di.setScale(.4)
        leadBut.setInteractive().on('pointerdown', () => {
            vkBridge.send("VKWebAppShowLeaderBoardBox", {user_result: 100})
        });
        share.setInteractive().on('pointerdown', () => {
            let text = ``;
            vkBridge.send("VKWebAppStorageGet", {"keys": ["score"]}).then((r)=>{
                console.log("SHARE",r)
                if(r.keys.length > 0){
                    text = parseInt(r.keys[0].value);
                }else text = 0;
                vkBridge.send("VKWebAppShowWallPostBox", {
                    "message": `Я смог набрать ${text} очков! кто сможет побить мой рекорд?!`,
                    "attachments": "https://vk.com/app7950158"
                });
            });

            /*vkBridge.send("VKWebAppShowLeaderBoardBox", {user_result: 100})*/
        });
        di.setInteractive().on('pointerdown', () => {
            if (!startGame) {
                startGamef(this);
                di.destroy()
                log.destroy()
                share.destroy()
                leadBut.destroy()
            }
        });
        scoreText.setDepth(5)
        sky[0] = this.physics.add.sprite(width / 2, height, 'sky');
        sky[1] = this.physics.add.sprite(width / 2, height - 1024, 'sky');
        sky[2] = this.physics.add.sprite(width / 2, height - 1024, 'sky');
        if (width > 1024) {
            sky[0].setScale(3)
            sky[1].setScale(3)
            sky[2].setScale(3)
        }
        //sky.setScale(10)
        player = this.physics.add.sprite(width / 2, height - 50, 'blue_player');//this.add.image(width/2,height/2,"blue_player")

        player.setScale(.6);
        player.body.collideWorldBounds = true;
        player.setDepth(3)

        player.body.setSize(player.width - 80, player.height - 100);

        this.anims.create({
            key: "booman",
            frameRate: 30,
            frames: this.anims.generateFrameNumbers("booman", {start: 0, end: 20}),
            repeat: 1
        });
        this.input.on('pointerup', function (pointer) {
            if (!gameOver && startGame)
                player.body.reset(player.x, player.y);
        }, this);
        /* this.input.on('pointerdown', function (pointer) {
             console.log(pointer)
             if(!startGame) {
                 startGamef(this);
                 di.destroy()
                 leadBut.destroy()
             }
         }, this);*/


        /*this.anims.create({
            key: "fly",
            frameRate:30,
            frames: this.anims.generateFrameNumbers("fire", { start: 0, end: 1 }),
            repeat: -1,
            showOnStart: true,
        });*/

        scoreInterval = setInterval(() => {
            if (!gameOver && startGame)
                score++;
            scoreText.setText(score);
            if (score === 20) {
                speedAsteroids += 20;
                spawnDelay -= 200;
            }
            if (score === 50) {
                speedAsteroids += 30;
                spawnDelay -= 250;
            }
            if (score === 80) {
                speedAsteroids += 30;
                spawnDelay -= 650;
            }
            if (score === 110) {
                speedAsteroids += 50;
                spawnDelay -= 950;
            }
        }, 1000)
        startGame = false;
        //this.scene.pause();
        /*fireFly = this.add.sprite(100, 100, "fire");
        fireFly.setDepth(2)
        fireFly.setScale(.5);
        fireFly.setOrigin(0,1)

        fireFly.play("fly");*/
        /*this.add.image(400, 300, 'sky');

        var particles = this.add.particles('red');

        var emitter = particles.createEmitter({
            speed: 100,
            scale: { start: 1, end: 0 },
            blendMode: 'ADD'
        });

        var logo = this.physics.add.image(400, 100, 'logo');

        logo.setVelocity(100, 200);
        logo.setBounce(1, 1);
        logo.setCollideWorldBounds(true);

        emitter.startFollow(logo);*/
    }

    function startGamef(th) {
        sky[0].body.velocity.y = 80;
        sky[1].body.velocity.y = 80;
        sky[2].body.velocity.y = 80;
        spawnAsteroid(th);
        th.physics.add.overlap(player, asteroids[0], boom);
        setTimeout(() => {
            spawnAsteroid(th)
        }, 1200)
        startGame = true;
    }
</script>
</body>
</html>